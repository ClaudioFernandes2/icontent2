define(["jquery","jqueryui","mod_icontent/cookiehandler"],function(t,e,a){function n(){if(!t("#idcommentnote").val().trim())return t("#idcommentnote").focus().val(""),!1;var e=t(this),a={action:"savereturnpagenotes",id:t(this).attr("data-cmid"),pageid:t(this).attr("data-pageid"),sesskey:t(this).attr("data-sesskey"),comment:t("#idcommentnote").val(),tab:"note",private:t("#idprivate").is(":checked")?1:0,featured:t("#idfeatured").is(":checked")?1:0,doubttutor:0};s(e),a="&"+t.param(a),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:a,success:function(a){t("#idpagenotesnote").html(a.notes),t("#idcommentnote").val(""),t("#messagenotes").text(a.totalnotes),i(e)}})}function o(){if(!t("#idcommentdoubt").val().trim())return t("#idcommentdoubt").focus().val(""),!1;var e=t(this),a={action:"savereturnpagenotes",id:t(this).attr("data-cmid"),pageid:t(this).attr("data-pageid"),sesskey:t(this).attr("data-sesskey"),comment:t("#idcommentdoubt").val(),tab:"doubt",doubttutor:t("#iddoubttutor").is(":checked")?1:0,private:0,featured:0};s(e),a="&"+t.param(a),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:a,success:function(a){t("#idpagenotesdoubt").html(a.notes),t("#idcommentdoubt").val(""),t("#messagedoubt").text(a.totalnotes),i(e)}})}function s(e){e.hide(),t(".icontent-page").children(".fulltextpage").prepend(t("<div />").addClass("loading").html('<img src="pix/loading.gif" alt="Loading" class="img-loading" />')).css("opacity","0.5")}function i(e){e.show(),t(".icontent-page").children(".fulltextpage").css("opacity","1").children(".loading").remove(),e.removeAttr("disabled")}function c(){var e=t(this).children("span"),a={action:"likenote",id:t(this).attr("data-cmid"),pagenoteid:t(this).attr("data-pagenoteid"),sesskey:t(this).attr("data-sesskey")};a="&"+t.param(a),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:a,success:function(t){e.text(t.likes)}})}function d(e){var a=e.data.lastcomment;t(this).parent(".buttonscomment").parent(".notecomment").text(a)}function r(){var e=t(this).parent(".buttonscomment").parent(".notecomment"),a=e.children(".textnotecomment").val();if(!a.trim())return e.children(".textnotecomment").focus().val(""),!1;var n={action:"editnote",id:e.attr("data-cmid"),pagenoteid:e.attr("data-pagenoteid"),sesskey:e.attr("data-sesskey"),comment:a};n="&"+t.param(n),t(this).prop("disabled",!0),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:n,success:function(t){e.text(t.comment)}})}function l(){var e=t(this).parent(".notefooter").parent(".noterowicontent").children(".notecomment"),a=e.text();e.text("").append(t("<textarea />").addClass("textnotecomment span11").text(a)).append(t("<div />").addClass("buttonscomment").append(t("<button />").addClass("btnnotesave").html('<i class="fa fa-floppy-o"></i>')).append(t("<button />").addClass("btnnotecancel").html('<i class="fa fa-times"></i>'))),t(".textnotecomment").focus(),t(".btnnotecancel").click({lastcomment:a},d),t(".btnnotesave").click(r)}function m(){t(this).parent(".buttonscomment").parent(".notecomment").children(".replynotecomment").remove(),t(this).parent(".buttonscomment").remove()}function p(){var e=t(this).parent(".buttonscomment").parent(".notecomment"),a=e.children(".replynotecomment").val();if(!a.trim())return e.children(".replynotecomment").focus().val(""),!1;var n={action:"replynote",id:e.attr("data-cmid"),parent:e.attr("data-pagenoteid"),sesskey:e.attr("data-sesskey"),comment:a};n="&"+t.param(n),t(this).prop("disabled",!0),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:n,success:function(a){t("#message"+a.tab).text(a.totalnotes),t("#pnote"+parseInt(a.parent)).after(a.reply),e.children(".replynotecomment").remove(),e.children(".buttonscomment").remove()}})}function u(){var e=t(this).parent(".notefooter").parent(".noterowicontent").children(".notecomment");e.children(".replynotecomment").length||(t(".replynotecomment").remove(),t(".buttonscomment").remove(),e.append(t("<textarea />").addClass("replynotecomment span").attr("required","required").attr("maxlength",1024)).append(t("<div />").addClass("buttonscomment").append(t("<button />").addClass("btnnotereplysave").html('<i class="fa fa-floppy-o"></i>')).append(t("<button />").addClass("btnnotereplycancel").html('<i class="fa fa-times"></i>')))),t(".replynotecomment").focus(),t(".btnnotereplycancel").click(m),t(".btnnotereplysave").click(p)}function h(){"yes"==a.cookie("highcontrast")?(a.cookie("highcontrast",null,{path:"/"}),t(".fulltextpage").removeClass("highcontrast").css("background-color","#FCFCFC")):(a.cookie("highcontrast","yes",{expires:7,path:"/"}),t(".fulltextpage").addClass("highcontrast").css({"background-color":"#000000","background-image":"none"}))}function f(){var e=t("#idfulltab .itab-content #doubt"),a=t("#idfulltab .itab-content #note");e.css({display:"none"}),a.css({display:"block"}),t("#idfulltab .inav-tabs .itab-doubt").removeClass("active"),t("#idfulltab .inav-tabs .itab-note").addClass("active")}function b(){var e=t("#idfulltab .itab-content #doubt");t("#idfulltab .itab-content #note").css({display:"none"}),e.css({display:"block"}),t("#idfulltab .inav-tabs .itab-note").removeClass("active"),t("#idfulltab .inav-tabs .itab-doubt").addClass("active")}function v(){var e=t(this).serialize(),a={action:"saveattempt",id:parseInt(t("#idhfieldcmid").val()),sesskey:t("#idhfieldsesskey").val(),formdata:e};return t(".btn-sendanswers").prop("disabled",!0),t.ajax({type:"POST",dataType:"json",url:"ajax.php",data:a,success:function(e){t("#idquestionsarea").html(e.grid)}}),!1}function g(e){var a=e.data.idtogle;t(a).toggle("fade",{},500),t(this).toggleClass("closed",500),t(this).hasClass("closed")?t(this).children("i").removeClass("fa-caret-down").addClass("fa-caret-right"):t(this).children("i").removeClass("fa-caret-right").addClass("fa-caret-down")}function y(){t(this).hide(),t(".suspension-points").hide(),t(".read-more-target").show("fade"),t(".read-more-state-off").show()}function k(){t(this).hide(),t(".read-more-target").hide("fade"),t(".suspension-points").show(),t(".read-more-state-on").show()}return{init:function(){var e=t("#idicontentpages");e.on("click","#idbtnsavenote",n),e.on("click","#idbtnsavedoubt",o),e.on("click","#idtitlenotes",{idtogle:"#idfulltab"},g),e.on("click","#idtitlequestionsarea",{idtogle:"#idcontentquestionsarea"},g),e.on("click",".read-more-state-on",y),e.on("click",".read-more-state-off",k),e.on("click",".likenote",c),e.on("click",".editnote",l),e.on("click",".replynote",u),e.on("click",".togglehighcontrast",h),e.on("click","#note-tab",f),e.on("click","#doubt-tab",b),e.on("submit","#idformquestions",v)}}});